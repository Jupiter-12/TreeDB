# TreeDB 开发原则与规范

## 通用开发原则

### 1. KISS (Keep It Simple, Stupid)
- **能简则简**：系统应尽可能简单，避免不必要的复杂度。
- **优先直观方案**：选择最直接、可维护的实现，即便需要多一点流程/组件。
- **易读易维护**：代码要让后来者快速看懂，避免晦涩或过度抽象。

### 2. DRY (Don't Repeat Yourself)
- **避免重复**：每个知识点/业务逻辑在系统中应只有一处可靠实现。
- **提炼复用**：通过函数、类、模块、模板等消除重复。
- **统一来源**：同类功能应依赖可复用的单一实现。

### 3. YAGNI (You Aren't Gonna Need It)
- **只做当下需要**：不要为未来可能的需求提前写代码。
- **控制范围**：不添加当前未使用的参数、接口、配置。
- **按需演进**：确有需要时再扩展或重构。

### 4. SOLID 原则

#### 单一职责原则 (Single Responsibility Principle)
- **一个模块一类职责**：每个模块只对一类需求/变化负责。
- **高内聚**：相关功能放在一起，不相关的拆开。
- **职责清晰**：接口和边界明确，便于替换和测试。

#### 开闭原则 (Open/Closed Principle)
- **对扩展开放**：系统应能通过新增代码实现新需求。
- **对修改关闭**：避免频繁修改已稳定的核心代码。
- **用抽象扩展**：优先通过接口/抽象类/组合实现扩展。

#### 里氏替换原则 (Liskov Substitution Principle)
- **子类可替父类**：子类型必须完全遵循父类型契约。
- **不破坏约定**：重写时不能削弱前置条件或破坏既有行为。

#### 接口隔离原则 (Interface Segregation Principle)
- **小而专一的接口**：客户端不应被迫依赖未使用的方法。
- **按需拆分**：将胖接口拆成多组专用接口。

#### 依赖倒置原则 (Dependency Inversion Principle)
- **依赖抽象**：高层和低层都应依赖接口/抽象，而非具体实现。
- **控制反转**：通过注入（构造/方法/配置）完成解耦。

### 5. 文档与注释原则
- **可读性优先**：文档和注释帮助他人快速理解核心流程。
- **格式统一**：保持一致的标题层级、列表与代码块风格。
- **及时更新**：文档随需求/实现变化及时同步。
- **注重原因**：注释更多解释“为何如此”而非“代码做了什么”。
- **问题留痕**：对已知问题/待办提供链接或说明。

## 原则冲突时的处理
- **优先 DRY**：先消除重复，确保唯一实现，再考虑其他优化。
- **兼顾 KISS**：去重后接口保持简单、易读；必要时以简洁的包装层减轻抽象复杂度。
- **遵守 YAGNI**：提炼只覆盖现有需求，不为未来假设预留复杂度。
- **正确性/安全优先**：当性能或抽象与正确性/安全/测试冲突时，先保证正确性和可验证性。
- **记录取舍**：如需折中，在变更记录或注释中说明原因，便于后续优化。

## 项目特定规范

### 目录组织
```
treedb/
├── public/          # 前端静态资源
│   ├── css/         # 样式文件（按模块拆分）
│   └── js/          # JavaScript 文件（模块化）
├── server/          # 后端服务代码
│   ├── config/      # 配置管理
│   ├── models/      # 数据模型
│   ├── handlers/    # 路由处理
│   ├── services/    # 业务逻辑
│   └── utils/       # 工具函数
└── docs/            # 项目文档
```

### 命名规范
- **文件/目录**：小写加下划线（snake_case）。
- **类/构造函数**：大写驼峰（PascalCase）。
- **变量/函数/方法**：小写驼峰（camelCase）。
- **常量**：全大写加下划线（UPPER_SNAKE_CASE）。
- **私有成员**：下划线前缀 `_private`。

### API 设计规范
- **RESTful**：使用标准 HTTP 方法与资源路径。
- **统一响应**：成功与错误响应保持一致结构。
- **版本管理**：API 应通过版本号区分。
- **完整文档**：每个 API 端点都要有参数与示例说明。

### 前端代码规范
- **ES6+ 语法**：使用现代 JavaScript。
- **模块化**：使用 ES6 模块体系。
- **事件管理**：优先事件委托和自定义事件。
- **类型增强**：如需，可选用类型约束/校验。
- **响应式布局**：优先 CSS Grid / Flexbox。

### CSS 组织原则
- **避免重复**：同一选择器只在一处定义。
- **合理顺序**：按层级和依赖整理样式。
- **使用 CSS 变量**：统一主题与常量。
- **按模块拆分**：每个模块样式放在对应文件。
- **覆盖有限**：覆盖样式应局部化，避免全局污染。
- **限制嵌套**：选择器嵌套不超过 3 层。
- **清理冗余**：定期移除未使用/重复样式。

### 后端代码规范
- **分层架构**：表示层 / 业务层 / 数据访问层分离。
- **依赖注入**：通过构造函数或方法注入依赖。
- **异常处理**：统一捕获与错误响应。
- **日志记录**：关键流程和错误必须记录。

## DRY 原则的具体落实

### 需要去重的对象
- **JavaScript**：工具函数、常量、业务逻辑实现唯一。
- **CSS**：选择器定义唯一。
- **Python**：函数/类避免重复实现，可用继承/组合。
- **HTML**：ID 全局唯一。
- **配置/脚本**：命令脚本应集中管理，避免分散拷贝。

### 重复识别方法
1. **使用工具扫描**：在项目目录运行重复检测脚本。
2. **代码评审**：提交前检查是否存在重复实现。
3. **历史回顾**：重构时复查是否仍有重复。
4. **模块化思维**：将通用功能抽成独立模块。

### 常见重复模式
- **初始化函数**：如 `init()`/`initialize()`。
- **工具函数**：如 `escapeHtml`、`showToast`、`clear`。
- **事件绑定**：如 `bindEvents`、`handle*` 系列。
- **配置获取/更新**：如 `getConfig`、`updateConfig`。
- **会话管理**：如 `createSession`、`deleteSession`。
- **错误处理**：相似的 try-catch/错误响应逻辑。
- **旧版本残留**：以 `*_original.py` 命名的备份实现。

### 去重流程

#### 1. 扫描工具
```python
# 运行全局重复扫描脚本，关注以下重复来源：
# - JavaScript 工具/类/函数
# - CSS 选择器
# - Python 函数/类
# - HTML ID
```

#### 2. 优先级处理顺序
1. **核心重复源**：如 `server_original.py` 等历史文件。
2. **通用工具函数**：如 `escapeHtml`、`showToast` 等高频调用。
3. **样式重复**：CSS 选择器和公共样式。
4. **分散实现**：零散的配置或业务逻辑。

#### 3. 统一实现原则
- **选定唯一实现**：评估并选出覆盖面最全的版本。
- **替换引用**：用唯一实现替换所有调用处。
- **删除重复**：移除重复实现，必要时保留变更记录。
- **验证行为**：确保替换后行为一致。

#### 4. 模块化组织
```
utils/
├── core.js        # 核心工具函数（如 escapeHtml, formatDate）
├── utils.js       # 通用 UI 工具（modal, confirmation）
├── session.js     # 会话管理
├── state.js       # 状态管理
└── dom-helper.js  # DOM 操作封装
```

#### 5. 实施步骤
1. **识别重复**：使用脚本和代码审查列出重复项。
2. **选择最佳实现**：明确保留版本和接口形态。
3. **批量替换**：修改依赖文件，统一调用。
4. **删除冗余**：移除重复代码/文件。
5. **清理临时文件**：删掉扫描/对比产生的中间文件。
6. **更新文档**：记录处理过程与规范。

#### 6. 预防重复的习惯
- **先查后写**：新增功能前先检索是否已有实现。
- **复用优先**：扩展已有模块而不是平行重写。
- **抽公共模块**：遇到重复及时抽成公共模块。
- **加强 Code Review**：评审关注潜在重复。

## 项目文件清理规范

### 目录与文件
- **backups/**：仅存放已归档参考版本
  - `index.html.backup`：1.0 版本参考实现
  - 其他历史文件仅作参考，不参与运行

### 需删除的文件类型
- **调试脚本**：`debug_*.js`、`test_*.html`
- **重复扫描脚本**：`find_duplicates*.py`
- **临时文件**：`*_temp*`、`*.bak`、`*~`
- **旧版备份**：`*_original.py` 等

### 清理原则
1. **定期清理**：每次迭代结束检查并清理冗余文件。
2. **数据备份**：重要变更先备份到 `backups/` 目录。
3. **必要即删**：确认无用后及时删除。
4. **记录变更**：清理操作应记录在变更日志。
5. **删除前确认**：删除前与相关人员确认，特别是：
   - 调试脚本（`debug_*.js`, `test_*.html`）
   - 重复扫描脚本（`find_duplicates*.py`）
   - 临时文件（`*_temp*`, `*.bak`, `*~`）
   - 旧版备份（`*_original.py`）
   - 任何生成/编译产物

## 自检清单

### 设计与代码
- [ ] 是否遵守 KISS（简洁可维护）？
- [ ] 是否消除重复（符合 DRY）？
- [ ] 是否避免超前实现（符合 YAGNI）？
- [ ] 模块是否单一职责？
- [ ] 扩展是否无需改动核心？
- [ ] 是否存在重复的函数/类/常量/样式？
- [ ] JavaScript 标识符是否唯一？
- [ ] CSS 选择器是否唯一且无冲突？
- [ ] Python 是否有不必要重复实现？
- [ ] HTML ID 是否全局唯一？

### 代码质量
- [ ] 代码风格是否一致？
- [ ] 命名与格式是否统一？
- [ ] 注释是否必要且准确？
- [ ] 是否存在未使用代码？

### 性能与安全
- [ ] 是否有性能瓶颈？
- [ ] 用户输入是否正确校验？
- [ ] 是否存在安全隐患？
- [ ] 资源使用是否合理？

### 测试
- [ ] 是否有足够的自动/手工测试？
- [ ] 新功能是否覆盖主要用例？
- [ ] 是否验证边界条件？

## 测试规范
- **修改前备份**：变更前先备份关键文件。
- **使用日志**：调试用日志而非散落的 `console.log`。
- **完整回归**：功能完成后跑回归/自测清单。
- **版本管理**：重要变更前确保提交或打标签。

## 变更流程
1. **提出需求**：明确目标和验收标准。
2. **设计讨论**：评估方案和风险。
3. **小步提交**：每次只改一小块，便于回滚。
4. **及时测试**：每次修改后立即验证。
5. **更新清单**：对照自检清单确认完成。
6. **同步文档**：更新相关文档。

---

*最后更新：2025-11-17*  
*提示：能用清晰代码就不要写注释；需要注释时应解释“为什么”而非“做了什么”。*  
*CSS 应按模块拆分并避免重复，保持结构清晰。*
