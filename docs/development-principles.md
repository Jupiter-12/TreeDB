# TreeDB 开发原则与规范

## 核心开发原则

### 1. KISS (Keep It Simple, Stupid) 原则
- **保持简单**：代码应该尽可能简单明了，避免不必要的复杂性
- **简单胜过复杂**：选择最简单的解决方案，而不是过度工程化
- **清晰的表达**：代码应该是自文档化的，易于理解

### 2. DRY (Don't Repeat Yourself) 原则
- **避免重复**：每一份知识和逻辑都应该在系统中只有一个单一、明确的表示
- **代码复用**：通过函数、类、模块等方式复用代码
- **抽象共同点**：将相似的功能抽象成可复用的组件

### 3. YAGNI (You Aren't Gonna Need It) 原则
- **只实现当前需要的功能**：不要为未来可能的需求编写代码
- **避免过度设计**：不要添加当前不需要的抽象层或功能
- **即时重构**：当需要时再进行重构和扩展

### 4. SOLID 原则

#### 单一职责原则 (Single Responsibility Principle)
- **一个类/模块只做一件事**：每个模块应该只有一个改变的理由
- **功能内聚**：相关的功能应该组织在一起
- **职责明确**：避免大而全的类或函数

#### 开闭原则 (Open/Closed Principle)
- **对扩展开放**：系统应该能够通过添加新代码来扩展���能
- **对修改关闭**：不应该需要修改现有代码来添加新功能
- **使用抽象**：通过接口和抽象类实现可扩展性

#### 里氏替换原则 (Liskov Substitution Principle)
- **子类必须能够替换父类**：子类应该完全兼容父类的接口
- **保持契约**：子类不能破坏父类的预期行为

#### 接口隔离原则 (Interface Segregation Principle)
- **小而专一的接口**：不应该强迫客户端依赖它们不使用的接口
- **按需拆分**：将大接口拆分成多个小接口

#### 依赖倒置原则 (Dependency Inversion Principle)
- **依赖抽象**：高层模块不应该依赖低层模块，两者都应该依赖抽象
- **控制反转**：通过依赖注入实现松耦合

### 5. 代码优雅原则
- **可读性优先**：代码首先是写给人读的，其次才是给机器执行的
- **一致性的风格**：保持统一的命名、格式和结构
- **有意义命名**：变量、函数、类的名称应该清楚地表达其意图
- **适当的注释**：注释应该解释"为什么"，而不是"是什么"
- **错误处理**：优雅地处理错误情况，提供有意义的错误信息

## 项目特定规范

### 文件组织
```
treedb/
├── public/          # 前端静态资源
│   ├── css/        # 样式文件（按组件分离）
│   └── js/         # JavaScript文件（按模块分离）
├── server/         # 后端服务器代码
│   ├── config/     # 配置管理
│   ├── models/     # 数据模型
│   ├── handlers/   # 请求处理器
│   ├── services/   # 业务服务
│   └── utils/      # 工具函数
└── docs/           # 项目文档
```

### 命名规范
- **文件命名**：使用小写字母和下划线（snake_case）
- **类命名**：使用大驼峰命名法（PascalCase）
- **函数/变量命名**：使用小驼峰命名法（camelCase）
- **常量命名**：使用大写字母和下划线（UPPER_SNAKE_CASE）
- **私有成员**：使用下划线前缀（_private）

### API 设计规范
- **RESTful 风格**：使用标准 HTTP 方法和资源路径
- **统一的响应格式**：成功和错误都应该有明确的结构
- **版本控制**：API 应该考虑版本兼容性
- **文档化**：每个 API 端点都应该有清晰的文档

### 前端代码规范
- **ES6+ 语法**：使用现代 JavaScript 特性
- **模块化**：使用 ES6 模块系统
- **事件驱动**：使用事件委托和自定义事件
- **渐进增强**：基础功能优先，高级特性可选
- **响应式设计**：使用 CSS Grid 和 Flexbox

### CSS 组织原则
- **避免重复定义**：相同的CSS选择器只应在一个文件中定义
- **正确的加载顺序**：基础样式先加载，组件样式后加载
- **使用CSS变量**：统一使用CSS自定义属性（变量）管理主题
- **组件化CSS**：每个组件的样式应独立在单独的文件中
- **优先复用而非重写**：需要相同样式时，应复用现有类而非创建新类
- **避免过度嵌套**：CSS选择器嵌套不应超过3层
- **清理无用样式**：定期检查并删除重复或未使用的CSS规则

### 后端代码规范
- **分层架构**：清晰的表示层、业务层、数据访问层
- **依赖注入**：通过构造函数或方法参数注入依赖
- **异常处理**：统一的异常处理机制
- **日志记录**：关键操作和错误应该记录日志

## DRY 原则具体实施

### 跨语言防重复策略
- **JavaScript**：函数名、类名、常量名应唯一
- **CSS**：类选择器只应在一个文件中定义
- **Python**：函数和类名应避免重复，除非是继承关系
- **HTML**：ID属性在页面中必须唯一
- **常量定义**：所有常量应该集中管理，避免多处定义

### 重复定义识别方法
1. **使用工具检测**：运行项目根目录的重复检测脚本
2. **代码审查**：在代码提交前检查是否存在重复实现
3. **定期重构**：定期检查和清理重复代码
4. **模块化思维**：将通用功能抽象成独立模块

### 常见的重复模式
- **初始化函数**：多个文件中的 `init()` 或 `initialize()`
- **工具函数**：`escapeHtml`, `showToast`, `clear` 等通用功能
- **事件处理**：`bindEvents`, `handle*` 系列函数
- **配置相关**：`getConfig`, `updateConfig` 等配置管理
- **会话管理**：`createSession`, `deleteSession` 等会话操作
- **错误处理**：相似的 try-catch 块和错误处理逻辑
- **旧版代码残留**：重构后保留的 `*_original.py` 等文件

### 重复定义清理最佳实践

#### 1. 创建检测工具
```python
# 创建一个全面的重复检测脚本
# 检查所有文件类型的重复定义：
# - JavaScript：函数、类、常量
# - CSS：类选择器
# - Python：函数、类
# - HTML：ID属性
```

#### 2. 优先级处理顺序
1. **最严重的重复源**：如 `server_original.py` 这类包含大量重复的文件
2. **通用工具函数**：`escapeHtml`, `showToast` 等被多处使用的函数
3. **样式重复**：CSS 类选择器的重复定义
4. **常量和配置**：分散在各处的常量定义

#### 3. 统一实现原则
- **选择最完整的实现**：保留功能最全、测试最充分的版本
- **更新所有引用**：使用全局搜索替换更新所有导入和使用
- **删除重复代码**：彻底删除重复的定义，不要保留"备用"版本
- **验证功能**：确保清理后功能正常运行

#### 4. 模块化组织
```
utils/
├── core.js       # 核心工具函数（escapeHtml, formatDate等）
├── utils.js      # 通用工具（modal, confirmation等）
├── session.js    # 会话管理
├── state.js      # 状态管理
└── dom-helper.js # DOM操作辅助
```

#### 5. 实施步骤
1. **识别重复**：运行检测脚本，列出所有重复定义
2. **评估选择**：确定保留哪个实现（通常是最完整的）
3. **更新导入**：修改所有文件，导入统一实现
4. **替换调用**：将局部调用替换为统一实现
5. **删除重复**：删除所有重复定义
6. **清理临时文件**：删除检测脚本等临时文件
7. **更新文档**：记录清理过程和规范

#### 6. 避免重复的编码习惯
- **先查后写**：实现新功能前，先检查是否已有类似实现
- **导入优于重写**：需要已存在功能时，导入而不是重写
- **抽象通用功能**：发现重复时，立即抽象成公共模块
- **定期Code Review**：团队定期审查代码，发现潜在重复

## 项目文件管理规范

### 保留的目录和文件
- **backups/** - 保留所有备份文件，包含旧版本代码参考
  - `index.html.backup` - 1.0版本的参考实现
  - 其他备份文件作为重构参考

### 需要清理的文件类型
- **调试脚本** - `debug_*.js`, `test_*.html`
- **重复检测脚本** - `find_duplicates*.py`
- **临时文件** - `*_temp*`, `*.bak`, `*~`
- **旧版代码** - `*_original.py`（重构后应删除）

### 清理原则
1. **定期清理**：每次功能完成后清理调试文件
2. **备份分离**：重要的备份保留在 backups/ 目录
3. **不要删除**：backups/ 目录下的所有文件
4. **文档记录**：清理操作应记录在开发日志中
5. **删除前确认**：删除任何文件前必须先与用户确认，包括：
   - 调试脚本（debug_*.js, test_*.html）
   - 重复检测脚本（find_duplicates*.py）
   - 临时文件（*_temp*, *.bak, *~）
   - 旧版代码（*_original.py）
   - 任何非源代码的文件

## 代码审查清单

### 代码质量
- [ ] 代码是否符合 KISS 原则（简单明了）？
- [ ] 是否存在重复代码（违反 DRY 原则）？
- [ ] 是否实现了当前不需要的功能（违反 YAGNI 原则）？
- [ ] 每个模块是否只负责一个职责？
- [ ] 代码是否容易扩展而不需要修改？
- [ ] 是否有重复的函数/类/常量定义？（跨文件检查）
- [ ] JavaScript函数名是否唯一？
- [ ] CSS类选择器是否有重复定义？
- [ ] Python函数和类是否有不必要的重复？
- [ ] HTML ID是否在页面中唯一？

### 代码风格
- [ ] 命名是否清晰有意义？
- [ ] 代码格式是否一致？
- [ ] 注释是否必要且有用？
- [ ] 是否有未使用的代码？

### 性能和安全
- [ ] 是否存在性能瓶颈？
- [ ] 是否正确处理用户输入？
- [ ] 是否有安全漏洞？
- [ ] 资源使用是否合理？

### 测试
- [ ] 是否有足够的测试覆盖？
- [ ] 测试是否容易理解和维护？
- [ ] 是否考虑了边界情况？

## 调试规范
- **调试前备份**：修改前先备份原始代码
- **使用日志**：使用日志而不是 console.log 进行调试
- **清理调试代码**：调试完成后必须清理所有调试痕迹
- **版本控制**：每次重大修改前提交代码

## 开发工作流
1. **理解需求**：清楚地理解功能需求
2. **设计先行**：先设计再编码
3. **小步迭代**：每次只做一个小改进
4. **及时测试**：每次修改后立即测试
5. **代码审查**：按照本清单进行自我审查
6. **文档更新**：及时更新相关文档

---

*最后更新：2025-11-17*
*记住：好的代码不需要注释，因为它自解释；需要注释的代码往往不够清晰。*
*CSS如中药，君臣佐使，各司其职，不可重复冗余，方得清爽。*